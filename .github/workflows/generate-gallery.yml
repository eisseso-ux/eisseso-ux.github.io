name: Generate Recursive Gallery JSON

on:
  push:
    paths:
      - 'images/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3

      - name: Generate gallery.json in every folder recursively
        run: |
          # Find every directory inside images/
          find images -type d | while read dir; do

            echo "Processing $dir"

            output="$dir/gallery.json"

            # Find images directly inside this directory only
            images=$(find "$dir" -maxdepth 1 -type f \( \
              -iname "*.jpg" -o \
              -iname "*.jpeg" -o \
              -iname "*.png" -o \
              -iname "*.webp" -o \
              -iname "*.gif" \
            \) | sort)

            # Skip folder if no images inside it
            if [ -z "$images" ]; then
              echo "No images in $dir â€” skipping"
              continue
            fi

            echo "[" > "$output"

            echo "$images" | sed 's/^/"/; s/$/",/' >> "$output"

            sed -i '$ s/,$//' "$output"
            echo "]" >> "$output"

          done

      - name: Commit updated gallery.json files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add images/**/gallery.json
          git commit -m "Auto-update recursive gallery.json files" || echo "No changes"
          git push