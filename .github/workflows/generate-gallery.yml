name: Generate Per-Folder Gallery JSON

on:
  push:
    paths:
      - 'images/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3

      - name: Generate gallery.json in each image subfolder
        run: |
          # Find all subdirectories inside images/
          for dir in images/*/ ; do
            if [ -d "$dir" ]; then
              echo "Processing $dir"

              output="${dir}gallery.json"

              echo "[" > "$output"

              find "$dir" -maxdepth 1 -type f \( \
                -iname "*.jpg" -o \
                -iname "*.jpeg" -o \
                -iname "*.png" -o \
                -iname "*.webp" -o \
                -iname "*.gif" \
              \) | sort | sed "s|^|\"|; s|$|\",|" >> "$output"

              sed -i '$ s/,$//' "$output"
              echo "]" >> "$output"
            fi
          done

      - name: Commit updated gallery.json files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add images/**/gallery.json
          git commit -m "Auto-update per-folder gallery.json" || echo "No changes"
          git push